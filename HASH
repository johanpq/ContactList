#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define TABLE_SIZE 5000
#define FILE_PATH "C:\\Users\\Cliente\\Desktop\\AV2\\todosOsContatos.txt"

typedef struct {
    char nome[100];
    char telefone[20];
} Contato;

typedef struct Node {
    Contato contato;
    struct Node* next;
} Node;

Node* hashTable[TABLE_SIZE];

unsigned int hashFunction(char* key) {
    unsigned int hash = 0;
    int i;
    for (i = 0; i < strlen(key); i++) {
        hash += key[i];
    }
    return hash % TABLE_SIZE;
}

void insert(char* nome, char* telefone) {
    Contato* novoContato = (Contato*)malloc(sizeof(Contato));
    strcpy(novoContato->nome, nome);
    strcpy(novoContato->telefone, telefone);

    unsigned int index = hashFunction(nome);
    Node* newNode = (Node*)malloc(sizeof(Node));
    newNode->contato = *novoContato;
    newNode->next = NULL;

    if (hashTable[index] == NULL) {
        hashTable[index] = newNode;
    } else {
        Node* temp = hashTable[index];
        while (temp->next != NULL) {
            temp = temp->next;
        }
        temp->next = newNode;
    }
}

void readFromFileAndInsert(char* filename, int numContatos) {
    FILE* file = fopen(filename, "r");
    if (file == NULL) {
        printf("Erro ao abrir o arquivo %s\n", filename);
        exit(1);
    }

    char line[256];
    char nome[100];
    char telefone[20];
    int contatosInseridos = 0;

    while (fgets(line, sizeof(line), file) != NULL && contatosInseridos < numContatos) {
        if (strstr(line, "Nome:") != NULL) {
            sscanf(line, "Nome: %[^\n]", nome);
        } else if (strstr(line, "Telefone:") != NULL) {
            sscanf(line, "Telefone: %[^\n]", telefone);
            insert(nome, telefone);
            contatosInseridos++;
        }
    }

    fclose(file);
}

char* search(char* nome) {
    unsigned int index = hashFunction(nome);
    Node* temp = hashTable[index];
    while (temp != NULL) {
        if (strcmp(temp->contato.nome, nome) == 0) {
            return temp->contato.telefone;
        }
        temp = temp->next;
    }
    return "Contato não encontrado";
}

void removeContact(char* nome) {
    unsigned int index = hashFunction(nome);
    Node* temp = hashTable[index];
    Node* prev = NULL;
    while (temp != NULL) {
        if (strcmp(temp->contato.nome, nome) == 0) {
            if (prev == NULL) {
                hashTable[index] = temp->next;
            } else {
                prev->next = temp->next;
            }
            free(temp);
            return;
        }
        prev = temp;
        temp = temp->next;
    }
}

void Menu() {
    printf("===== Lista de Contatos =====\n");
    printf("      1. Inserir             \n");
    printf("      2. Buscar              \n");
    printf("      3. Remover             \n");
    printf("      4. Sair                \n");
    printf("=============================\n");
}

int main() {
    // Inicializando a tabela hash
    for (int i = 0; i < TABLE_SIZE; i++) {
        hashTable[i] = NULL;
    }

    // Lendo e inserindo os 5000 primeiros contatos do arquivo na tabela hash
    readFromFileAndInsert(FILE_PATH, 5000);

    int choice = 0;
    char nome[100];
    char telefone[20];

    do {
        Menu();
        scanf("%d", &choice);
        switch (choice) {
            case 1:
                printf("Nome: ");
                scanf(" %[^\n]", nome);
                printf("Telefone: ");
                scanf("%s", telefone);
                insert(nome, telefone);
                printf("Contato inserido com sucesso!\n");
                break;

            case 2:
                printf("Buscar por: ");
                scanf(" %[^\n]", nome);
                printf("Telefone: %s\n", search(nome));
                break;

            case 3:
                printf("Insira o nome da pessoa para remover: ");
                scanf(" %[^\n]", nome);
                removeContact(nome);
                printf("Contato removido com sucesso!\n");
                break;

            case 4:
                printf("Saindo...\n");
                break;

            default:
                printf("Opção inválida!\n");
        }
    } while (choice != 4);

    return 0;
}
